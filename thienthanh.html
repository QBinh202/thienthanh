<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vòng quay may mắn</title>
<style>
:root{
  --size: 600px;
  --radius: calc(var(--size)/2);
  --center-size: 180px;
  --img-size: 80px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,Roboto,Arial;
  display:grid;place-items:center;
  min-height:100vh;
  background:#f6f7fb;
  color:#0f172a;
}
h1{text-align:center;font-weight:800;margin-bottom:6px}
p{text-align:center;opacity:.7;margin-bottom:20px}

.stage{position:relative;width:var(--size);height:var(--size);margin:auto;}
.wheel{
  position:absolute;inset:0;border-radius:50%;
  transform:rotate(var(--rot,0deg));
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  overflow:hidden;
}

.pointer{
  position:absolute;
  top:-25px;left:50%;transform:translateX(-50%);
  width:0;height:0;
  border-left:14px solid transparent;border-right:14px solid transparent;
  border-top:30px solid #ef4444;z-index:10;
  filter:drop-shadow(0 3px 6px rgba(0,0,0,.3));
}
.center{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;}
.start-btn{
  pointer-events:auto;cursor:pointer;
  width:var(--center-size);height:var(--center-size);border-radius:50%;
  font-weight:700;font-size:24px;text-align:center;line-height:1.1;
  background:radial-gradient(circle at 30% 30%,#fff,#f1f5f9);
  border:6px solid #fff;box-shadow:0 10px 20px rgba(0,0,0,.2);
  transition:transform .2s ease,opacity .2s ease;
}
.start-btn:hover{transform:scale(1.05)}
.start-btn:active{transform:scale(.97)}
.start-btn.disabled{opacity:.5;pointer-events:none}

.controls{width:min(900px,92vw);margin:20px auto 8px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
#fileInput{flex:1}
.filelist{
  margin-top:12px;background:#fff;border-radius:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.08);padding:10px 12px;
  max-height:210px;overflow:auto
}
.filelist .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-weight:700}
.filelist .items{display:grid;grid-template-columns:repeat(auto-fill, minmax(180px,1fr));gap:10px}
.fileitem{
  display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;
  background:#f8fafc;border:1px solid #e2e8f0;
}
.fileitem img{width:40px;height:40px;object-fit:cover;border-radius:8px;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.12)}
.fileitem .name{font-size:12px;font-weight:700;line-height:1.2;word-break:break-word;flex:1}
.fileitem .delbtn{
  background:#fee2e2;border:1px solid #fecaca;border-radius:8px;padding:4px 8px;cursor:pointer;font-size:12px
}
.fileitem .delbtn:hover{background:#fecaca}

.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:100;
}
.overlay.show{display:flex;}
.winner-box{
  background:#fff;padding:20px 30px;border-radius:12px;
  box-shadow:0 20px 40px rgba(0,0,0,.3);animation:pop .4s ease
}
.winner-box img{max-width:320px;max-height:320px;object-fit:cover;border-radius:10px}
@keyframes pop{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}

.toast{
  position:fixed;bottom:14px;left:50%;transform:translateX(-50%);
  background:#111827;color:#fff;padding:8px 14px;border-radius:10px;font-weight:600;display:none;z-index:150
}
.toast.show{display:block}
</style>
</head>
<body>
<main>
  <h1>Vòng quay tư thế</h1>
  <p>Thiên Thanh là người tuyệt vời nhất trong lòng anh, thương em bạn nhỏ của anh</p>

  <div class="stage">
    <div class="pointer"></div>
    <div id="wheel" class="wheel"></div>
    <div class="center"><button id="startBtn" class="start-btn">BẮT<br>ĐẦU</button></div>
  </div>

  <section class="controls">
    <div class="row">
      <input id="fileInput" type="file" multiple accept="image/*">
      <label>Thời gian quay (giây): <input id="spinTime" type="number" min="1" max="20" step="0.5" value="6" style="width:80px"></label>
    </div>

    <div class="filelist" id="fileList" hidden>
      <div class="header">
        <span>Danh sách ảnh</span>
        <span id="count"></span>
      </div>
      <div class="items" id="fileItems"></div>
    </div>
  </section>
</main>

<div id="overlay" class="overlay">
  <div class="winner-box"><img id="winnerImg" src="" alt="winner"></div>
</div>
<div id="toast" class="toast">Hết ảnh — hãy chọn thêm ảnh mới.</div>

<script>
// =================== CẤU HÌNH ===================
let SPIN_TIME = 6;     // thời gian quay (giây)
const BASE_TURNS = 5;  // vòng quay cơ bản trước khi dừng
// =================================================

const wheel = document.getElementById('wheel');
const startBtn = document.getElementById('startBtn');
const fileInput = document.getElementById('fileInput');
const spinTimeInput = document.getElementById('spinTime');
const overlay = document.getElementById('overlay');
const winnerImg = document.getElementById('winnerImg');
const toast = document.getElementById('toast');

const fileList = document.getElementById('fileList');
const fileItems = document.getElementById('fileItems');
const countEl = document.getElementById('count');

let pool = [];        // danh sách ảnh đang chơi [{id, src, name}]
let spinning = false;
let sliceAngle = 0;
let rotation = 0;
let lastWinnerId = null;

const pastel=['#fde68a','#bfdbfe','#fbcfe8','#a7f3d0','#fcd34d','#c7d2fe','#f9a8d4','#99f6e4','#fef08a','#ddd6fe'];

function uid(){ return Math.random().toString(36).slice(2,10); }

function rebuildFileUI(){
  fileItems.innerHTML = '';
  if(pool.length===0){
    fileList.hidden = true;
    countEl.textContent = '';
    startBtn.classList.add('disabled');
    return;
  }
  fileList.hidden = false;
  startBtn.classList.remove('disabled');
  countEl.textContent = `${pool.length} ảnh`;
  for(const it of pool){
    const card = document.createElement('div');
    card.className = 'fileitem';
    card.dataset.id = it.id;

    const im = document.createElement('img');
    im.src = it.src;

    const name = document.createElement('div');
    name.className='name';
    name.textContent = it.name || 'Ảnh';

    const del = document.createElement('button');
    del.className='delbtn';
    del.textContent='Xoá';
    del.addEventListener('click', ()=>{
      removeById(it.id);
      renderWheel();
    });

    card.appendChild(im);
    card.appendChild(name);
    card.appendChild(del);
    fileItems.appendChild(card);
  }
}

function renderWheel(){
  wheel.innerHTML = '';
  if(pool.length===0){ wheel.style.background='#f1f5f9'; return; }
  sliceAngle = 360 / pool.length;

  // nền lát màu
  let stops='';
  for(let i=0;i<pool.length;i++){
    const c=pastel[i%pastel.length], s=i*sliceAngle, e=(i+1)*sliceAngle;
    stops += `${c} ${s}deg ${e}deg,`;
  }
  wheel.style.background = `conic-gradient(from -90deg, ${stops.slice(0,-1)})`;

  // ảnh theo tâm lát
  pool.forEach((img,i)=>{
    const mid = i*sliceAngle + sliceAngle/2;
    const wrap = document.createElement('div');
    wrap.style.position='absolute';
    wrap.style.left='43%';
    wrap.style.top='43%';
    wrap.style.transform = `
      rotate(${mid}deg)
      translate(calc(var(--radius) - (var(--center-size)/4.5) - var(--img-size)/4.5))
      rotate(${-mid}deg)
    `;
    wrap.style.transformOrigin='center';
    wrap.style.display='grid';
    wrap.style.placeItems='center';

    const im = document.createElement('img');
    im.src = img.src;
    im.style.width='var(--img-size)';
    im.style.height='var(--img-size)';
    im.style.objectFit='cover';
    im.style.borderRadius='10px';
    im.style.border='3px solid #fff';
    im.style.boxShadow='0 2px 6px rgba(0,0,0,.25)';
    wrap.appendChild(im);
    wheel.appendChild(wrap);
  });
}

function spin(){
  if(spinning || pool.length===0) return;
  spinning = true;

  // cập nhật thời gian quay từ input
  SPIN_TIME = Math.max(0.5, Number(spinTimeInput.value) || SPIN_TIME);
  wheel.style.transition = `transform ${SPIN_TIME}s cubic-bezier(0.1, 0.8, 0.3, 1)`;

  const idx = Math.floor(Math.random()*pool.length);
  const turns = BASE_TURNS + Math.random()*3;
  const target = 360*turns - idx*sliceAngle; // dừng đúng giữa lát trúng
  rotation = target;
  wheel.style.setProperty('--rot', rotation + 'deg');

  lastWinnerId = pool[idx].id;

  wheel.addEventListener('transitionend', ()=>{
    spinning = false;
    showWinner(pool[idx].src);
  }, {once:true});
}

function showWinner(src){
  winnerImg.src = src;
  overlay.classList.add('show');
}

function removeById(id){
  // xoá khỏi pool
  const ix = pool.findIndex(x=>x.id===id);
  if(ix>=0) pool.splice(ix,1);

  // xoá khỏi UI danh sách
  const card = fileItems.querySelector(`[data-id="${id}"]`);
  if(card) card.remove();

  // reset góc để tránh lệch sau khi giảm lát
  wheel.style.transition = 'none';
  rotation = 0;
  wheel.style.setProperty('--rot','0deg');

  // cập nhật UI
  rebuildFileUI();
  renderWheel();

  if(pool.length===0){
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1600);
  }
}

// Đóng popup → xoá ảnh trúng khỏi pool & danh sách
overlay.addEventListener('click', ()=>{
  overlay.classList.remove('show');
  if(lastWinnerId){
    removeById(lastWinnerId);
    lastWinnerId = null;
  }
});

fileInput.addEventListener('change', async e=>{
  const files = Array.from(e.target.files); // không giới hạn
  const readers = files.map(f => new Promise(res=>{
    const r = new FileReader();
    r.onload = () => res({ id: uid(), src: r.result, name: f.name });
    r.readAsDataURL(f);
  }));
  const loaded = await Promise.all(readers);

  // thay thế danh sách hiện tại bằng lần chọn mới
  pool = loaded;

  rebuildFileUI();
  renderWheel();

  // reset quay
  wheel.style.transition='none';
  rotation=0;
  wheel.style.setProperty('--rot','0deg');
});

startBtn.addEventListener('click', spin);
</script>
</body>
</html>
